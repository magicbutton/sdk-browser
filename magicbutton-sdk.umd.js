!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).MagicButtonSDK={})}(this,(function(e){"use strict";var t=(e=>(e.SCRAPING="scraping",e.SDK="sdk",e.USER_INPUT="user_input",e.TOOL_UPDATE="tool_update",e.INFERENCE="inference",e.IMPORT="import",e.API="api",e))(t||{}),s=Object.defineProperty,i=Object.defineProperties,n=Object.getOwnPropertyDescriptors,a=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,d=(e,t,i)=>t in e?s(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,l=(e,t)=>{for(var s in t||(t={}))o.call(t,s)&&d(e,s,t[s]);if(a)for(var s of a(t))r.call(t,s)&&d(e,s,t[s]);return e},h=(e,t)=>i(e,n(t)),c=(e,t,s)=>d(e,"symbol"!=typeof t?t+"":t,s),u=(e,t,s)=>new Promise(((i,n)=>{var a=e=>{try{r(s.next(e))}catch(t){n(t)}},o=e=>{try{r(s.throw(e))}catch(t){n(t)}},r=e=>e.done?i(e.value):Promise.resolve(e.value).then(a,o);r((s=s.apply(e,t)).next())}));class g{constructor(e={}){c(this,"config"),c(this,"isInitialized",!1),c(this,"isExtensionAvailable",!1),c(this,"messageQueue",[]),c(this,"eventHandlers",new Map),c(this,"nodeRegistry",new Map),c(this,"handshakeSessionId",null),c(this,"handshakeInProgress",!1),c(this,"accessToken",null),c(this,"tokenExpiresAt",null),this.config=l({namespace:"magicbutton-sdk",enableAutoCollection:!0,enableUserTracking:!1,debug:!1},e),this.log("SDK created with config:",this.config)}initialize(){return u(this,null,(function*(){if(this.isInitialized)return this.log("SDK already initialized"),this.isExtensionAvailable;this.log("Initializing SDK...");try{return this.isExtensionAvailable=yield this.detectExtension(),this.isExtensionAvailable?(this.setupMessageBridge(),yield this.registerPage(),this.config.enableAutoCollection&&this.enableAutoCollection(),yield this.processMessageQueue(),this.log("SDK initialized successfully")):this.log("Extension not detected - SDK running in standalone mode"),this.isInitialized=!0,this.emit("sdk:initialized",{available:this.isExtensionAvailable}),this.isExtensionAvailable}catch(e){return this.error("Failed to initialize SDK:",e),!1}}))}detectExtension(){return u(this,null,(function*(){return new Promise((e=>{window.postMessage({type:"MAGICBUTTON_SDK_DETECTION",timestamp:Date.now()},window.location.origin);const t=s=>{s.source===window&&"MAGICBUTTON_EXTENSION_RESPONSE"===s.data.type&&(window.removeEventListener("message",t),e(!0))};window.addEventListener("message",t),setTimeout((()=>{window.removeEventListener("message",t),e(!1)}),1e3)}))}))}setupMessageBridge(){window.addEventListener("message",(e=>{e.source===window&&"MAGICBUTTON_SDK_RESPONSE"===e.data.type&&this.handleExtensionMessage(e.data)}))}registerPage(){return u(this,null,(function*(){const e=this.collectPageData();yield this.sendMessage({type:"REGISTER_PAGE",data:h(l({},e),{sdkVersion:"2.0.0",config:this.config})})}))}collectPageData(){return{url:window.location.href,title:document.title,timestamp:Date.now(),userAgent:navigator.userAgent,referrer:document.referrer,openGraph:this.extractOpenGraphData(),structuredData:this.extractStructuredData()}}extractOpenGraphData(){const e={};return document.querySelectorAll('meta[property^="og:"]').forEach((t=>{var s;const i=null==(s=t.getAttribute("property"))?void 0:s.replace("og:",""),n=t.getAttribute("content");i&&n&&(e[i]=n)})),e}extractStructuredData(){const e=document.querySelectorAll('script[type="application/ld+json"]'),t=[];return e.forEach((e=>{try{const s=JSON.parse(e.textContent||"");t.push(s)}catch(s){this.log("Failed to parse structured data:",s)}})),t}addNode(e){return u(this,null,(function*(){const s=e.id||this.generateNodeId();return this.nodeRegistry.set(s,h(l({},e),{id:s})),this.isExtensionAvailable&&(yield this.sendMessage({type:"ADD_NODE",data:h(l({id:s},e),{source:t.SDK,timestamp:Date.now()})})),this.emit("node:added",{nodeId:s,node:e}),s}))}addEdge(e){return u(this,null,(function*(){const s=this.generateEdgeId();return this.isExtensionAvailable&&(yield this.sendMessage({type:"ADD_EDGE",data:h(l({id:s},e),{source:t.SDK,timestamp:Date.now()})})),this.emit("edge:added",{edgeId:s,edge:e}),s}))}trackAction(e,t){return u(this,null,(function*(){const s={type:e,data:t,timestamp:Date.now(),url:window.location.href,userAgent:navigator.userAgent};this.isExtensionAvailable&&(yield this.sendMessage({type:"TRACK_ACTION",data:s})),this.emit("action:tracked",s)}))}registerForTools(e){return u(this,null,(function*(){this.isExtensionAvailable&&(yield this.sendMessage({type:"REGISTER_TOOLS",data:{toolTypes:e}})),this.emit("tools:registered",{toolTypes:e})}))}requestConsent(e,t){return u(this,null,(function*(){if(!this.isExtensionAvailable)return!1;const s=yield this.sendMessage({type:"REQUEST_CONSENT",data:{dataTypes:e,purpose:t}}),i=(null==s?void 0:s.granted)||!1;return this.emit("consent:response",{granted:i,dataTypes:e,purpose:t}),i}))}getUserContext(){return u(this,null,(function*(){if(!this.isExtensionAvailable)return null;const e=yield this.sendMessage({type:"GET_USER_CONTEXT"});return(null==e?void 0:e.context)||null}))}onToolActivated(e){this.on("tool:activated",e)}onGraphUpdated(e){this.on("graph:updated",e)}initiateHandshake(e){return u(this,null,(function*(){if(this.log("🤝 Initiating handshake with request:",e),!this.isExtensionAvailable)throw this.error("❌ Extension not available for handshake"),new Error("Magic Button extension not available");if(this.handshakeInProgress)throw this.warn("⚠️ Handshake already in progress"),new Error("Handshake already in progress");this.handshakeInProgress=!0;try{this.log("📤 Sending handshake message to extension...");const t={type:"INITIATE_HANDSHAKE",data:{siteName:e.siteName,siteUrl:e.siteUrl,permissions:e.permissions,purpose:e.purpose,timestamp:Date.now()}};this.log("📋 Message payload:",t);const s=yield this.sendMessage(t);if(this.log("📥 Received handshake response:",s),null==s?void 0:s.success)return this.handshakeSessionId=s.sessionId,this.log("✅ Handshake initiated successfully, session ID:",s.sessionId),this.emit("handshake:initiated",s),s;throw this.error("❌ Handshake initiation failed:",null==s?void 0:s.error),new Error((null==s?void 0:s.error)||"Handshake initiation failed")}catch(t){throw this.error("💥 Handshake error:",t),t}finally{this.handshakeInProgress=!1}}))}submitHandshakeCode(e){return u(this,null,(function*(){if(!this.isExtensionAvailable)throw new Error("Magic Button extension not available");if(!this.handshakeSessionId)throw new Error("No active handshake session. Call initiateHandshake() first.");if(!/^\d{6}$/.test(e))throw new Error("Code must be exactly 6 digits");this.log("Submitting handshake code:",e);try{const t=yield this.sendMessage({type:"SUBMIT_HANDSHAKE_CODE",data:{sessionId:this.handshakeSessionId,code:e,timestamp:Date.now()}});if(null==t?void 0:t.success)return this.accessToken=t.token,this.tokenExpiresAt=t.expiresAt,this.emit("handshake:completed",{sessionId:this.handshakeSessionId,token:t.token,permissions:t.permissions,expiresAt:t.expiresAt}),this.log("Handshake completed successfully"),!0;throw this.emit("handshake:failed",{sessionId:this.handshakeSessionId,error:null==t?void 0:t.error}),new Error((null==t?void 0:t.error)||"Invalid handshake code")}catch(t){const e=t instanceof Error?t.message:"Unknown error";throw this.emit("handshake:failed",{sessionId:this.handshakeSessionId,error:e}),t}}))}cancelHandshake(){return u(this,null,(function*(){this.handshakeSessionId&&(this.isExtensionAvailable&&(yield this.sendMessage({type:"CANCEL_HANDSHAKE",data:{sessionId:this.handshakeSessionId,timestamp:Date.now()}})),this.emit("handshake:cancelled",{sessionId:this.handshakeSessionId}),this.handshakeSessionId=null,this.handshakeInProgress=!1)}))}checkHandshakeStatus(){return u(this,null,(function*(){if(!this.isExtensionAvailable)return{required:!1};const e=yield this.sendMessage({type:"CHECK_HANDSHAKE_STATUS",data:{siteUrl:window.location.href,timestamp:Date.now()}});return{required:(null==e?void 0:e.required)||!1,sessionId:null==e?void 0:e.sessionId}}))}getHandshakeSessionId(){return this.handshakeSessionId}isHandshakeInProgress(){return this.handshakeInProgress}openSidepanel(){return u(this,null,(function*(){if(!this.isExtensionAvailable)throw new Error("Magic Button extension not available");try{this.log("Opening sidepanel");const e=yield this.sendMessage({type:"OPEN_SIDEPANEL"});if(null==e?void 0:e.success)return this.emit("sidepanel:opened",{timestamp:Date.now()}),!0;throw new Error((null==e?void 0:e.error)||"Failed to open sidepanel")}catch(e){throw this.error("Failed to open sidepanel:",e),e}}))}getAccessToken(){return this.tokenExpiresAt&&Date.now()>this.tokenExpiresAt?(this.accessToken=null,this.tokenExpiresAt=null,this.emit("token:expired",{timestamp:Date.now()}),null):this.accessToken}isAuthenticated(){return null!==this.getAccessToken()}clearAuthentication(){this.accessToken=null,this.tokenExpiresAt=null,this.emit("authentication:cleared",{timestamp:Date.now()})}enableAutoCollection(){this.trackPageNavigation(),this.config.enableUserTracking&&this.trackUserInteractions(),this.trackFormSubmissions(),this.monitorDOMChanges()}trackPageNavigation(){this.trackAction("page_loaded",this.collectPageData()),window.addEventListener("beforeunload",(()=>{this.trackAction("page_unloaded",{url:window.location.href,timeOnPage:Date.now()-window.__magicButtonPageLoadTime})}));const e=history.pushState,t=history.replaceState;history.pushState=(...t)=>{e.apply(history,t),this.trackAction("navigation",{type:"pushState",url:window.location.href})},history.replaceState=(...e)=>{t.apply(history,e),this.trackAction("navigation",{type:"replaceState",url:window.location.href})},window.addEventListener("popstate",(()=>{this.trackAction("navigation",{type:"popstate",url:window.location.href})}))}trackUserInteractions(){let e;document.addEventListener("click",(e=>{const t=e.target;this.trackAction("click",{tagName:t.tagName,className:t.className,id:t.id,href:t.getAttribute("href"),x:e.clientX,y:e.clientY})})),window.addEventListener("scroll",(()=>{clearTimeout(e),e=window.setTimeout((()=>{this.trackAction("scroll",{scrollY:window.scrollY,scrollX:window.scrollX,documentHeight:document.documentElement.scrollHeight,viewportHeight:window.innerHeight})}),500)}))}trackFormSubmissions(){document.addEventListener("submit",(e=>{const t=e.target,s=new FormData(t);for(const[n,a]of s.entries())this.isSensitiveField(n);const i=Array.from(s.entries()).length;this.trackAction("form_submitted",{action:t.action,method:t.method,fieldCount:i,hasFileUpload:Array.from(t.elements).some((e=>e instanceof HTMLInputElement&&"file"===e.type))})}))}monitorDOMChanges(){new MutationObserver((e=>{let t=!1;e.forEach((e=>{"childList"===e.type&&e.addedNodes.length>0&&(t=!0)})),t&&this.trackAction("dom_updated",{mutationCount:e.length,timestamp:Date.now()})})).observe(document.body,{childList:!0,subtree:!0})}isSensitiveField(e){return[/password/i,/ssn|social/i,/credit|card/i,/cvv|cvc/i,/bank/i,/secret/i,/token/i,/api[_-]?key/i].some((t=>t.test(e)))}sendMessage(e){return u(this,null,(function*(){return new Promise(((t,s)=>{if(!this.isExtensionAvailable)return this.warn("⚠️ Extension not available, queueing message:",e.type),this.messageQueue.push(e),void t(null);const i=this.generateMessageId();this.log("📤 Sending message to extension:",{messageId:i,type:e.type});const n=setTimeout((()=>{this.error("⏰ Message timeout for:",{messageId:i,type:e.type}),s(new Error(`Message timeout for ${e.type}`))}),5e3),a=o=>{o.source===window&&"MAGICBUTTON_SDK_RESPONSE"===o.data.type&&o.data.messageId===i&&(this.log("📥 Received response for message:",{messageId:i,type:e.type}),clearTimeout(n),window.removeEventListener("message",a),o.data.error?(this.error("❌ Extension returned error:",o.data.error),s(new Error(o.data.error))):t(o.data.response))};window.addEventListener("message",a);const o=h(l({},e),{token:this.getAccessToken()}),r={type:"MAGICBUTTON_SDK_MESSAGE",messageId:i,payload:o};this.log("📨 PostMessage payload:",r),window.postMessage(r,window.location.origin)}))}))}processMessageQueue(){return u(this,null,(function*(){for(;this.messageQueue.length>0;){const t=this.messageQueue.shift();try{yield this.sendMessage(t)}catch(e){this.error("Failed to send queued message:",e)}}}))}handleExtensionMessage(e){switch(e.type){case"TOOL_ACTIVATED":this.emit("tool:activated",e.tool);break;case"GRAPH_UPDATED":this.emit("graph:updated",e.update);break;case"CONSENT_REQUEST":this.handleConsentRequest(e);break;case"HANDSHAKE_CODE_GENERATED":this.emit("handshake:code-generated",e);break;case"HANDSHAKE_EXPIRED":this.emit("handshake:expired",e),this.handshakeSessionId=null,this.handshakeInProgress=!1;break;case"HANDSHAKE_SIDEPANEL_FLASH":this.emit("handshake:sidepanel-flash",e);break;default:this.log("Unknown message from extension:",e)}}handleConsentRequest(e){const t=confirm(`Allow Magic Button Player to access ${e.dataTypes.join(", ")} for ${e.purpose}?`);window.postMessage({type:"MAGICBUTTON_SDK_CONSENT_RESPONSE",requestId:e.requestId,granted:t},window.location.origin)}on(e,t){this.eventHandlers.has(e)||this.eventHandlers.set(e,[]),this.eventHandlers.get(e).push(t)}off(e,t){if(this.eventHandlers.has(e))if(t){const s=this.eventHandlers.get(e),i=s.indexOf(t);i>-1&&s.splice(i,1)}else this.eventHandlers.delete(e)}emit(e,t){(this.eventHandlers.get(e)||[]).forEach((e=>{try{e(t)}catch(s){this.error("Event handler error:",s)}}))}generateNodeId(){return`node_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}generateEdgeId(){return`edge_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}generateMessageId(){return`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}log(...e){this.config.debug&&console.log("[MagicButton SDK]",...e)}error(...e){console.error("[MagicButton SDK]",...e)}}if("undefined"!=typeof window){window.__magicButtonPageLoadTime=Date.now();const e=window.MagicButtonConfig;if(e||window.MagicButtonAutoInit){const t=new g(e);window.MagicButton=t,window.__MagicButtonSDK=t,t.initialize().then((e=>{e&&console.log("[MagicButton] SDK initialized successfully")}))}}e.MagicButtonSDK=g,e.default=g,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
//# sourceMappingURL=magicbutton-sdk.umd.js.map
