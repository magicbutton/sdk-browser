!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).MagicButtonSDK={})}(this,(function(e){"use strict";var t=(e=>(e.SCRAPING="scraping",e.SDK="sdk",e.USER_INPUT="user_input",e.TOOL_UPDATE="tool_update",e.INFERENCE="inference",e.IMPORT="import",e.API="api",e))(t||{}),i=Object.defineProperty,n=Object.defineProperties,s=Object.getOwnPropertyDescriptors,o=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,d=(e,t,n)=>t in e?i(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,l=(e,t)=>{for(var i in t||(t={}))a.call(t,i)&&d(e,i,t[i]);if(o)for(var i of o(t))r.call(t,i)&&d(e,i,t[i]);return e},c=(e,t)=>n(e,s(t)),u=(e,t,i)=>d(e,"symbol"!=typeof t?t+"":t,i),h=(e,t,i)=>new Promise(((n,s)=>{var o=e=>{try{r(i.next(e))}catch(t){s(t)}},a=e=>{try{r(i.throw(e))}catch(t){s(t)}},r=e=>e.done?n(e.value):Promise.resolve(e.value).then(o,a);r((i=i.apply(e,t)).next())}));class g{constructor(e={}){u(this,"config"),u(this,"isInitialized",!1),u(this,"isExtensionAvailable",!1),u(this,"messageQueue",[]),u(this,"eventHandlers",new Map),u(this,"nodeRegistry",new Map),this.config=l({namespace:"magicbutton-sdk",enableAutoCollection:!0,enableUserTracking:!1,debug:!1},e),this.log("SDK created with config:",this.config)}initialize(){return h(this,null,(function*(){if(this.isInitialized)return this.log("SDK already initialized"),this.isExtensionAvailable;this.log("Initializing SDK...");try{return this.isExtensionAvailable=yield this.detectExtension(),this.isExtensionAvailable?(this.setupMessageBridge(),yield this.registerPage(),this.config.enableAutoCollection&&this.enableAutoCollection(),yield this.processMessageQueue(),this.log("SDK initialized successfully")):this.log("Extension not detected - SDK running in standalone mode"),this.isInitialized=!0,this.emit("sdk:initialized",{available:this.isExtensionAvailable}),this.isExtensionAvailable}catch(e){return this.error("Failed to initialize SDK:",e),!1}}))}detectExtension(){return h(this,null,(function*(){return new Promise((e=>{window.postMessage({type:"MAGICBUTTON_SDK_DETECTION",timestamp:Date.now()},window.location.origin);const t=i=>{i.source===window&&"MAGICBUTTON_EXTENSION_RESPONSE"===i.data.type&&(window.removeEventListener("message",t),e(!0))};window.addEventListener("message",t),setTimeout((()=>{window.removeEventListener("message",t),e(!1)}),1e3)}))}))}setupMessageBridge(){window.addEventListener("message",(e=>{e.source===window&&"MAGICBUTTON_SDK_RESPONSE"===e.data.type&&this.handleExtensionMessage(e.data)}))}registerPage(){return h(this,null,(function*(){const e=this.collectPageData();yield this.sendMessage({type:"REGISTER_PAGE",data:c(l({},e),{sdkVersion:"2.0.0",config:this.config})})}))}collectPageData(){return{url:window.location.href,title:document.title,timestamp:Date.now(),userAgent:navigator.userAgent,referrer:document.referrer,openGraph:this.extractOpenGraphData(),structuredData:this.extractStructuredData()}}extractOpenGraphData(){const e={};return document.querySelectorAll('meta[property^="og:"]').forEach((t=>{var i;const n=null==(i=t.getAttribute("property"))?void 0:i.replace("og:",""),s=t.getAttribute("content");n&&s&&(e[n]=s)})),e}extractStructuredData(){const e=document.querySelectorAll('script[type="application/ld+json"]'),t=[];return e.forEach((e=>{try{const i=JSON.parse(e.textContent||"");t.push(i)}catch(i){this.log("Failed to parse structured data:",i)}})),t}addNode(e){return h(this,null,(function*(){const i=e.id||this.generateNodeId();return this.nodeRegistry.set(i,c(l({},e),{id:i})),this.isExtensionAvailable&&(yield this.sendMessage({type:"ADD_NODE",data:c(l({id:i},e),{source:t.SDK,timestamp:Date.now()})})),this.emit("node:added",{nodeId:i,node:e}),i}))}addEdge(e){return h(this,null,(function*(){const i=this.generateEdgeId();return this.isExtensionAvailable&&(yield this.sendMessage({type:"ADD_EDGE",data:c(l({id:i},e),{source:t.SDK,timestamp:Date.now()})})),this.emit("edge:added",{edgeId:i,edge:e}),i}))}trackAction(e,t){return h(this,null,(function*(){const i={type:e,data:t,timestamp:Date.now(),url:window.location.href,userAgent:navigator.userAgent};this.isExtensionAvailable&&(yield this.sendMessage({type:"TRACK_ACTION",data:i})),this.emit("action:tracked",i)}))}registerForTools(e){return h(this,null,(function*(){this.isExtensionAvailable&&(yield this.sendMessage({type:"REGISTER_TOOLS",data:{toolTypes:e}})),this.emit("tools:registered",{toolTypes:e})}))}requestConsent(e,t){return h(this,null,(function*(){if(!this.isExtensionAvailable)return!1;const i=yield this.sendMessage({type:"REQUEST_CONSENT",data:{dataTypes:e,purpose:t}}),n=(null==i?void 0:i.granted)||!1;return this.emit("consent:response",{granted:n,dataTypes:e,purpose:t}),n}))}getUserContext(){return h(this,null,(function*(){if(!this.isExtensionAvailable)return null;const e=yield this.sendMessage({type:"GET_USER_CONTEXT"});return(null==e?void 0:e.context)||null}))}onToolActivated(e){this.on("tool:activated",e)}onGraphUpdated(e){this.on("graph:updated",e)}enableAutoCollection(){this.trackPageNavigation(),this.config.enableUserTracking&&this.trackUserInteractions(),this.trackFormSubmissions(),this.monitorDOMChanges()}trackPageNavigation(){this.trackAction("page_loaded",this.collectPageData()),window.addEventListener("beforeunload",(()=>{this.trackAction("page_unloaded",{url:window.location.href,timeOnPage:Date.now()-window.__magicButtonPageLoadTime})}));const e=history.pushState,t=history.replaceState;history.pushState=(...t)=>{e.apply(history,t),this.trackAction("navigation",{type:"pushState",url:window.location.href})},history.replaceState=(...e)=>{t.apply(history,e),this.trackAction("navigation",{type:"replaceState",url:window.location.href})},window.addEventListener("popstate",(()=>{this.trackAction("navigation",{type:"popstate",url:window.location.href})}))}trackUserInteractions(){let e;document.addEventListener("click",(e=>{const t=e.target;this.trackAction("click",{tagName:t.tagName,className:t.className,id:t.id,href:t.getAttribute("href"),x:e.clientX,y:e.clientY})})),window.addEventListener("scroll",(()=>{clearTimeout(e),e=setTimeout((()=>{this.trackAction("scroll",{scrollY:window.scrollY,scrollX:window.scrollX,documentHeight:document.documentElement.scrollHeight,viewportHeight:window.innerHeight})}),500)}))}trackFormSubmissions(){document.addEventListener("submit",(e=>{const t=e.target,i=new FormData(t);for(const[n,s]of i.entries())this.isSensitiveField(n);this.trackAction("form_submitted",{action:t.action,method:t.method,fieldCount:i.size,hasFileUpload:Array.from(t.elements).some((e=>e instanceof HTMLInputElement&&"file"===e.type))})}))}monitorDOMChanges(){new MutationObserver((e=>{let t=!1;e.forEach((e=>{"childList"===e.type&&e.addedNodes.length>0&&(t=!0)})),t&&this.trackAction("dom_updated",{mutationCount:e.length,timestamp:Date.now()})})).observe(document.body,{childList:!0,subtree:!0})}isSensitiveField(e){return[/password/i,/ssn|social/i,/credit|card/i,/cvv|cvc/i,/bank/i,/secret/i,/token/i,/api[_-]?key/i].some((t=>t.test(e)))}sendMessage(e){return h(this,null,(function*(){return new Promise(((t,i)=>{if(!this.isExtensionAvailable)return this.messageQueue.push(e),void t(null);const n=this.generateMessageId(),s=setTimeout((()=>{i(new Error("Message timeout"))}),5e3),o=e=>{e.source===window&&"MAGICBUTTON_SDK_RESPONSE"===e.data.type&&e.data.messageId===n&&(clearTimeout(s),window.removeEventListener("message",o),t(e.data.response))};window.addEventListener("message",o),window.postMessage({type:"MAGICBUTTON_SDK_MESSAGE",messageId:n,payload:e},window.location.origin)}))}))}processMessageQueue(){return h(this,null,(function*(){for(;this.messageQueue.length>0;){const t=this.messageQueue.shift();try{yield this.sendMessage(t)}catch(e){this.error("Failed to send queued message:",e)}}}))}handleExtensionMessage(e){switch(e.type){case"TOOL_ACTIVATED":this.emit("tool:activated",e.tool);break;case"GRAPH_UPDATED":this.emit("graph:updated",e.update);break;case"CONSENT_REQUEST":this.handleConsentRequest(e);break;default:this.log("Unknown message from extension:",e)}}handleConsentRequest(e){const t=confirm(`Allow Magic Button Player to access ${e.dataTypes.join(", ")} for ${e.purpose}?`);window.postMessage({type:"MAGICBUTTON_SDK_CONSENT_RESPONSE",requestId:e.requestId,granted:t},window.location.origin)}on(e,t){this.eventHandlers.has(e)||this.eventHandlers.set(e,[]),this.eventHandlers.get(e).push(t)}off(e,t){if(this.eventHandlers.has(e))if(t){const i=this.eventHandlers.get(e),n=i.indexOf(t);n>-1&&i.splice(n,1)}else this.eventHandlers.delete(e)}emit(e,t){(this.eventHandlers.get(e)||[]).forEach((e=>{try{e(t)}catch(i){this.error("Event handler error:",i)}}))}generateNodeId(){return`node_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}generateEdgeId(){return`edge_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}generateMessageId(){return`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}log(...e){this.config.debug&&console.log("[MagicButton SDK]",...e)}error(...e){console.error("[MagicButton SDK]",...e)}}if("undefined"!=typeof window){window.__magicButtonPageLoadTime=Date.now();const e=window.MagicButtonConfig;if(e||window.MagicButtonAutoInit){const t=new g(e);window.MagicButton=t,window.__MagicButtonSDK=t,t.initialize().then((e=>{e&&console.log("[MagicButton] SDK initialized successfully")}))}}e.MagicButtonSDK=g,e.default=g,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
//# sourceMappingURL=magicbutton-sdk.umd.js.map
